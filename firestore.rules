rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ARCHITECTURE PRINCIPLE: Firestore is the source of truth.
    // These rules enforce the data model defined in backend.json.

    // ----------------
    // Helper Functions
    // ----------------
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    function isAdmin() {
      // ARCHITECTURE PRINCIPLE: Critical logic runs in backend. Admin status is managed by backend.
      // This function securely checks for admin privileges without exposing admin list.
      return isSignedIn() && exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }
    
    function isNewData(data) {
      return resource == null;
    }
    
    function existingData() {
      return resource.data;
    }
    
    function incomingData() {
      return request.resource.data;
    }

    // ----------------
    // Collection Rules
    // ----------------
    
    // User Profiles
    match /users/{userId} {
      allow get: if isSignedIn(); // Any signed-in user can view a profile.
      allow list: if isAdmin(); // Only admins can list all users.

      // A user can create their own profile. An admin can create any.
      allow create: if isOwner(userId) || isAdmin();
      
      // ARCHITECTURE PRINCIPLE: Clients never modify sensitive data.
      // The 'role' field can only be changed by an admin.
      allow update: if (isOwner(userId) && incomingData().role == existingData().role) || isAdmin();
      
      allow delete: if isAdmin(); // Only admins can delete user profiles.
    }
    
    // Services offered by a provider
    match /users/{userId}/services/{serviceId} {
        allow get, list: if true; // All services are public to view.
        
        // Only the provider can create/update/delete their own services.
        allow create, update, delete: if isOwner(userId);
    }
    
    // Customer's private record of their bookings.
    // ARCHITECTURE PRINCIPLE: Auditable and traceable writes.
    // The customer owns this record.
    match /users/{userId}/private_bookings/{bookingId} {
      allow get, list, create, update: if isOwner(userId);
      allow delete: if false; // Bookings should be cancelled, not deleted by clients.
    }

    // Provider's view of their bookings (denormalized read-only copy)
    // ARCHITECTURE PRINCIPLE: Denormalized for performance/security.
    match /providers/{providerId}/public_bookings/{bookingId} {
        allow get, list: if isOwner(providerId);
        
        // ARCHITECTURE PRINCIPLE: All critical logic runs in Cloud Functions.
        // This collection is read-only for clients. Cloud Functions will sync data here.
        allow write: if false; 
    }
    
    // Admin role management collection
    match /roles_admin/{userId} {
      // This collection is managed by backend/admins only.
      // No client-side reads or writes are allowed.
      allow read, write: if false;
    }
  }
}
