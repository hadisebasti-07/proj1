rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ARCHITECTURE PRINCIPLE: Firestore is the source of truth.
    // These rules enforce the data model defined in backend.json.

    // ----------------
    // Helper Functions
    // ----------------
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    function isAdmin() {
      // ARCHITECTURE PRINCIPLE: Admin status is verified by checking a server-controlled document.
      // This securely checks for admin privileges by reading a document that clients cannot write to.
      // It also checks the content of the document to ensure the 'isAdmin' flag is explicitly true.
      return isSignedIn() && 
             exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/roles_admin/$(request.auth.uid)).data.isAdmin == true;
    }
    
    function isNewData(data) {
      return resource == null;
    }
    
    function existingData() {
      return resource.data;
    }
    
    function incomingData() {
      return request.resource.data;
    }

    // ----------------
    // Collection Rules
    // ----------------
    
    // User Profiles
    match /users/{userId} {
      // A user can read their own profile, or an admin can.
      allow get: if isOwner(userId) || isAdmin();
      allow list: if isAdmin();

      // A user can create their own profile. An admin can create any.
      allow create: if isOwner(userId) || isAdmin();
      
      // ARCHITECTURE PRINCIPLE: Clients never modify sensitive data.
      // The 'role' field can only be changed by an admin.
      allow update: if (isOwner(userId) && incomingData().role == existingData().role) || isAdmin();
      
      allow delete: if isAdmin(); // Only admins can delete user profiles.
    }
    
    // Services are now in a top-level collection for easier querying.
    match /services/{serviceId} {
        allow get, list: if true; // All services are public to view.
        
        // Only the provider who owns the service can manage it.
        // We check the providerId field on the service document.
        allow create: if isOwner(incomingData().provider.id);
        allow update: if isOwner(resource.data.provider.id);
        allow delete: if isOwner(resource.data.provider.id);
    }

    // Provider public profiles
    match /providers/{providerId} {
      allow get, list: if true;
      allow create: if isAdmin();
      
      // An admin can update anything. A provider can only update their profile
      // if they are NOT changing their own status.
      allow update: if isAdmin() || (isOwner(providerId) && incomingData().status == existingData().status);

      allow delete: if isAdmin();
    }
    
    // Provider Availability
    match /providers/{providerId}/availability/{docId} {
       allow get: if isOwner(providerId) || isAdmin();
       allow list: if isOwner(providerId) || isAdmin();
       allow create, update: if isOwner(providerId);
       allow delete: if false; // Should be updated, not deleted.
    }

    // Bookings
    match /bookings/{bookingId} {
      // A customer or provider can get a booking they are involved in.
      allow get: if isSignedIn() && (resource.data.customerId == request.auth.uid || resource.data.providerId == request.auth.uid || isAdmin());
      
      // Admins can list all bookings for their console.
      // Non-admins must query bookings with a 'where' clause (e.g., where('customerId', '==', auth.uid))
      // which is implicitly allowed if the 'get' rule passes for each document in the result.
      allow list: if isAdmin();
      
      // A customer can create their own booking.
      allow create: if isOwner(incomingData().customerId);
      
      // A customer can cancel a pending/confirmed booking.
      // A provider can confirm a pending booking or complete a confirmed one.
      allow update: if (isOwner(existingData().customerId) && incomingData().status == 'cancelled') || 
                       (isOwner(existingData().providerId) && (
                         (existingData().status == 'pending' && incomingData().status == 'confirmed') ||
                         (existingData().status == 'confirmed' && incomingData().status == 'completed')
                       )) || isAdmin();

      // Bookings are archived (cancelled), not deleted by clients.
      allow delete: if false; 
    }
    
    // Admin role management collection
    match /roles_admin/{userId} {
      // This collection is managed by backend/admins only.
      // No client-side reads or writes are allowed for listing/writing.
      allow get: if isOwner(userId) || isAdmin();
      allow list, write: if false;
    }
    
    // --- Financial System Rules ---
    
    // Wallet documents
    match /wallets/{providerId} {
        // A provider can read their own wallet. Admins can read any wallet.
        allow get: if isOwner(providerId) || isAdmin();
        
        // NOBODY can write to the wallet directly from the client.
        // Balances are updated by backend functions.
        allow list, write: if false;
    }
    
    // Immutable Ledger entries
    match /wallets/{providerId}/ledger/{ledgerId} {
        // Only admins can read the full transaction history.
        allow get, list: if isAdmin();
        
        // NOBODY can write to the ledger from the client.
        // Ledger entries are created by backend functions only.
        allow write: if false;
    }
    
    // Payout Requests
    match /payout_requests/{payoutId} {
        // A provider can read their own payout requests. Admins can read all.
        allow get: if isOwner(resource.data.providerId) || isAdmin();
        allow list: if isAdmin(); // Admins can list all requests to manage them.
        
        // Providers can create new payout requests.
        allow create: if isOwner(incomingData().providerId);
        
        // Admins can approve/reject requests. Providers cannot change status.
        allow update: if isAdmin() && incomingData().keys().hasOnly(['status', 'adminNotes']);
        
        // Payouts are not deleted to maintain audit trail.
        allow delete: if false;
    }
  }
}
